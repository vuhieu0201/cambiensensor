import serial
import time
import numpy as np
import matplotlib.pyplot as plt

# ==== Cáº¥u hÃ¬nh ====
PORT = 'COM17'  # âš ï¸ Äáº·t Ä‘Ãºng COM ESP8266
BAUD = 9600
NUM_SAMPLES = 100

# ==== Dá»¯ liá»‡u ====
raw_values = []
filtered_values = []
timestamps = []

# ==== Káº¿t ná»‘i Serial ====
ser = serial.Serial(PORT, BAUD, timeout=1)
time.sleep(2)

print("ğŸ“¡ Äang thu dá»¯ liá»‡u Ä‘o...\n")

# ==== Thu tháº­p dá»¯ liá»‡u ====
start_time = time.time()
while len(raw_values) < NUM_SAMPLES:
    line = ser.readline().decode(errors='ignore').strip()
    timestamp = time.time() - start_time
    if "Raw" in line and "Filtered" in line:
        try:
            parts = line.split('|')
            raw = float(parts[0].split(':')[1].strip().replace("cm", ""))
            filtered = float(parts[1].split(':')[1].strip())
            raw_values.append(raw)
            filtered_values.append(filtered)
            timestamps.append(timestamp)

            if len(timestamps) >= 2:
                dt = (timestamps[-1] - timestamps[-2]) * 1000  # ms
                raw_response_time = dt
                filtered_response_time = dt * 2  # Æ¯á»›c lÆ°á»£ng EMA trá»… ~2 máº«u
                print(f" Raw: {raw:.2f} |  Filtered: {filtered:.2f} |  Raw: {raw_response_time:.1f} ms | Filtered: ~{filtered_response_time:.1f} ms")

        except:
            continue
ser.close()

# ==== PhÃ¢n tÃ­ch sau khi thu tháº­p ====
raw_np = np.array(raw_values)
filtered_np = np.array(filtered_values)
timestamps_np = np.array(timestamps)

# Khoáº£ng thá»i gian giá»¯a cÃ¡c máº«u (ms)
dt = np.diff(timestamps_np)
avg_dt_ms = np.mean(dt) * 1000

# Æ¯á»›c lÆ°á»£ng Ä‘á»™ trá»… EMA
estimated_filter_delay_ms = avg_dt_ms

# ==== Káº¿t quáº£ tá»•ng há»£p ====
print("\nğŸ“Š Káº¾T QUáº¢ PHÃ‚N TÃCH")
print(f"- Sá»‘ máº«u: {len(raw_values)}")
print(f"- Thá»i gian trung bÃ¬nh giá»¯a 2 máº«u: {avg_dt_ms:.2f} ms")
print(f"- Thá»i gian pháº£n há»“i trung bÃ¬nh (Raw): {avg_dt_ms:.2f} ms")
print(f"- Thá»i gian pháº£n há»“i trung bÃ¬nh (Filtered): ~{avg_dt_ms + estimated_filter_delay_ms:.2f} ms")
