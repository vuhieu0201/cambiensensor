import serial
import time
import numpy as np
import matplotlib.pyplot as plt

# ==== Cáº¥u hÃ¬nh ====
PORT = 'COM17'  
BAUD = 9600
GROUND_TRUTH = 10.0  # khoáº£ng cÃ¡ch thá»±c táº¿ (cm)

WINDOW_SIZE = 5  # Cá»­a sá»• lá»c trung bÃ¬nh

raw_values = []
filtered_values = []
timestamps = []

ser = serial.Serial(PORT, BAUD, timeout=1)
time.sleep(2)

print("ğŸ“¡ Äang thu dá»¯ liá»‡u Ä‘o...\n")

start_time = time.time()
while len(raw_values) < 100:
    line = ser.readline().decode(errors='ignore').strip()
    timestamp = time.time() - start_time
    if "Raw" in line:
        try:
            parts = line.split('|')
            raw = float(parts[0].split(':')[1].strip().replace("cm", ""))
            raw_values.append(raw)
            timestamps.append(timestamp)

            # Bá»™ lá»c trung bÃ¬nh Ä‘á»™ng
            if len(raw_values) >= WINDOW_SIZE:
                window = raw_values[-WINDOW_SIZE:]
                filtered = sum(window) / WINDOW_SIZE
            else:
                filtered = raw

            filtered_values.append(filtered)

            # TÃ­nh thá»i gian pháº£n há»“i
            if len(timestamps) >= 2:
                dt = (timestamps[-1] - timestamps[-2]) * 1000  # ms
                raw_response_time = dt
                # Äá»™ trá»… bá»™ lá»c trung bÃ¬nh Ä‘á»™ng ~ (WINDOW_SIZE-1)/2 máº«u
                filtered_response_time = dt * ((WINDOW_SIZE - 1) / 2)
                print(f"ğŸŸ  Raw: {raw:.2f} | ğŸ”µ Filtered: {filtered:.2f} | Raw: {raw_response_time:.1f} ms | Filtered: ~{filtered_response_time:.1f} ms")
            
        except:
            continue
ser.close()
# ==== PhÃ¢n tÃ­ch dá»¯ liá»‡u ====
raw_np = np.array(raw_values)
filtered_np = np.array(filtered_values)
timestamps_np = np.array(timestamps)

# Sai sá»‘ trung bÃ¬nh (%)
raw_error = np.abs(raw_np - GROUND_TRUTH) / GROUND_TRUTH * 100
filtered_error = np.abs(filtered_np - GROUND_TRUTH) / GROUND_TRUTH * 100

# Nhiá»…u (Ä‘á»™ lá»‡ch chuáº©n)
raw_std = np.std(raw_np)
filtered_std = np.std(filtered_np)
noise_reduction = (1 - filtered_std / raw_std) * 100 if raw_std != 0 else 0

# Thá»i gian trung bÃ¬nh giá»¯a cÃ¡c máº«u
time_diffs = np.diff(timestamps_np)
avg_sample_interval = np.mean(time_diffs) * 1000  # ms

# Æ¯á»›c lÆ°á»£ng Ä‘á»™ trá»… do lá»c trung bÃ¬nh
estimated_filter_delay = ((WINDOW_SIZE - 1) / 2) * avg_sample_interval
avg_response_time_raw = avg_sample_interval
avg_response_time_filtered = estimated_filter_delay

# ==== Káº¿t quáº£ ====
print("\n=== PHÃ‚N TÃCH ===")
print(f"Sá»‘ máº«u thu Ä‘Æ°á»£c: {len(raw_values)}")
print(f"Sai sá»‘ trung bÃ¬nh Raw (chÆ°a lá»c): {np.mean(raw_error):.2f}%")
print(f"Sai sá»‘ trung bÃ¬nh Filtered (lá»c trung bÃ¬nh): {np.mean(filtered_error):.2f}%")
print(f"Nhiá»…u Raw (std): {raw_std:.2f}")
print(f"Nhiá»…u Filtered (std): {filtered_std:.2f}")
print(f"Hiá»‡u quáº£ lá»c (giáº£m nhiá»…u): {noise_reduction:.2f}%")
print(f"Thá»i gian Ä‘Ã¡p á»©ng trung bÃ¬nh (Raw): {avg_response_time_raw:.2f} ms")
print(f"Thá»i gian Ä‘Ã¡p á»©ng trung bÃ¬nh (Filtered ~ trá»… hÆ¡n): {avg_response_time_filtered:.2f} ms")

# ==== Váº½ biá»ƒu Ä‘á»“ ====
plt.figure(figsize=(10, 5))
plt.plot(raw_np, label='Raw', linestyle='--', color='red')
plt.plot(filtered_np, label='Filtered (Moving Average)', color='blue')
plt.axhline(GROUND_TRUTH, color='green', linestyle=':', label='Ground Truth')
plt.xlabel('Chá»‰ sá»‘ máº«u')
plt.ylabel('Khoáº£ng cÃ¡ch (cm)')
plt.title('So sÃ¡nh Dá»¯ liá»‡u Raw vs Filtered (Moving Average)')
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()
